# ‚è∫ ‚ö†Ô∏è Analysis: DTEND Does NOT Limit Recurrence Series

After testing your proposed fix, I discovered it breaks RFC 5545 compliance. I've reverted the change. Here's why:

## üìñ RFC 5545 Specification

According to [RFC 5545 Section 3.6.1](https://datatracker.ietf.org/doc/html/rfc5545#section-3.6.1):

**DTEND defines the duration of each individual occurrence, NOT the end of the recurrence series.**

## üìä Example: What DTEND Actually Means

```json
{
  "dtstart": "2024-11-14T09:00:00",
  "dtend": "2024-11-14T17:00:00",
  "rrule": {
    "freq": "WEEKLY",
    "byday": ["TH"],
    "count": 4
  }
}
```

This creates 4 weekly Thursday events, each lasting 8 hours (9 AM to 5 PM):

- ‚úÖ Nov 14, 09:00 - 17:00
- ‚úÖ Nov 21, 09:00 - 17:00
- ‚úÖ Nov 28, 09:00 - 17:00
- ‚úÖ Dec 5, 09:00 - 17:00

**NOT events only until Nov 14 17:00!**

## ‚ùå Your Fix (Breaks Compliance)

```sql
-- This treats DTEND as series end - WRONG!
IF rruleset.dtend IS NOT NULL THEN
  tsrange_end := rruleset.dtend;
END IF;
```

Result: Breaks existing tests that expect RFC 5545-compliant behavior.

## ‚úÖ Correct Way to Limit Occurrences

Use UNTIL or COUNT in the RRULE:

### Option 1: Use UNTIL

```json
{
  "dtstart": "2024-11-14T17:30:00",
  "rrule": {
    "freq": "WEEKLY",
    "interval": 2,
    "byday": ["TH"],
    "until": "2024-12-01T00:00:00"
  }
}
```

### Option 2: Use COUNT

```json
{
  "dtstart": "2024-11-14T17:30:00",
  "rrule": {
    "freq": "WEEKLY",
    "interval": 2,
    "byday": ["TH"],
    "count": 3
  }
}
```

## üîç Test That Failed with Your Fix

```json
{
  "dtstart": "1997-09-02T09:00:00",
  "dtend": "1997-09-03T09:00:00",
  "rrule": {
    "freq": "WEEKLY",
    "count": 4
  }
}
```

**Expected (RFC 5545 compliant):**

- 1997-09-02 09:00 (each lasts 24 hours)
- 1997-09-09 09:00
- 1997-09-16 09:00
- 1997-09-23 09:00 ‚úÖ Correct

**Your fix returned:** Only 1997-09-02 09:00 ‚ùå Wrong!

## üìù Summary

| Field   | Purpose                     | Affects                    |
| ------- | --------------------------- | -------------------------- |
| DTSTART | Start of first occurrence   | Series start time          |
| DTEND   | Duration of each occurrence | Individual event length    |
| UNTIL   | End of recurrence series    | ‚úÖ When to stop generating |
| COUNT   | Number of occurrences       | ‚úÖ How many to generate    |

## üí° Solution for Your Use Case

If you want to limit occurrences to a specific date range, use UNTIL instead of DTEND:

```sql
SELECT occurrence
FROM _rrule.occurrences(
  _rrule.jsonb_to_rruleset('{
    "dtstart": "2024-11-14T17:30:00",
    "rrule": {
      "freq": "WEEKLY",
      "interval": 2,
      "byday": ["TH"],
      "until": "2024-12-01T00:00:00"
    }
  }'::jsonb)
) occurrence;
```

**Result:**

```
2024-11-14 17:30:00
2024-11-28 17:30:00
```

The implementation is correct per RFC 5545 - DTEND should not limit the recurrence series! ‚úÖ
